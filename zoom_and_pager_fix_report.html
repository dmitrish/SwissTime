<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SwissTime – Zoom and Pager Behavior: What Changed and Why It Works</title>
  <style>
    :root { --bg: #0e1116; --fg: #e6edf3; --muted:#9da7b3; --accent:#7cc4ff; --code-bg:#0b0f14; --border:#1f232a; }
    html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;line-height:1.55;margin:0;padding:0}
    main{max-width:980px;margin:0 auto;padding:28px 18px 60px}
    h1,h2,h3{line-height:1.2}
    h1{font-size:1.8rem;margin:0 0 6px}
    h2{font-size:1.3rem;margin:28px 0 10px}
    h3{font-size:1.05rem;margin:20px 0 8px}
    p{margin:10px 0}
    ul{margin:10px 0 10px 1.2rem}
    li{margin:6px 0}
    .muted{color:var(--muted)}
    .callout{border:1px solid var(--border);background:#0f1420;padding:14px;border-radius:10px}
    code, pre{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    pre{background:var(--code-bg);border:1px solid var(--border);padding:14px;border-radius:10px;overflow:auto}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    hr{border:none;border-top:1px solid var(--border);margin:24px 0}
    .file{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#10151f;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<main>
  <h1>SwissTime – Zoom and Pager Behavior: What Changed and Why It Works</h1>
  <p class="muted">Generated on 2025-11-23 22:54</p>

  <div class="callout">
    <p>This document explains the steps taken to fix three related issues in the watch selection screen and why each change resolves the observed behavior.</p>
    <ul>
      <li>API mismatch with <code>PagerDefaults.flingBehavior</code></li>
      <li>Vertical nudge of the entire pager band when toggling zoom</li>
      <li>Square artifact visible behind the watch during zoom-in</li>
    </ul>
  </div>

  <h2>Overview</h2>
  <p>
    The project uses the AndroidX Compose BOM (see <span class="file">gradle/libs.versions.toml</span>) which currently resolves Compose Foundation to a 1.9.x artifact.
    Some previously used parameters for pager fling configuration are not present in this version. Additionally, a layout refactor in
    <span class="file">WelcomeScreen.kt</span> introduced a height change in a bottom control which subtly shifted the pager vertically on zoom toggle. Finally, the animated layer for the focused watch was not being clipped at the outermost compositing stage, revealing a rectangular layer during scaling/transition.
  </p>

  <hr />
  <h2>Changes Made</h2>

  <h3>1) Update pager fling configuration to match current API</h3>
  <p><strong>Files:</strong> <span class="file">app/src/main/java/com/coroutines/swisstime/ui/components/SwissTimePager.kt</span></p>
  <ul>
    <li>Replaced usage of now-missing parameters (e.g., <code>lowVelocityAnimationSpec</code>) with a supported <code>snapAnimationSpec</code> and created a custom <code>flingBehavior</code> via <code>PagerDefaults.flingBehavior(state, snapAnimationSpec)</code>.</li>
    <li>Kept <code>userScrollEnabled = !isZoomed</code> to avoid unintended horizontal movement when zoomed.</li>
  </ul>
  <pre><code>// Inside SwissTimePager.kt
val customSnapAnimationSpec = tween&lt;Float&gt;(
    durationMillis = 300,
    easing = EaseOutCubic
)

val customFlingBehavior = PagerDefaults.flingBehavior(
    state = pagerState,
    snapAnimationSpec = customSnapAnimationSpec
)

HorizontalPager(
    state = pagerState,
    // ...
    userScrollEnabled = !isZoomed,
    flingBehavior = customFlingBehavior
) { page -&gt; /* ... */ }
</code></pre>
  <p><strong>Why this works:</strong> It aligns our code with the 1.9.x Foundation API, restoring build compatibility while preserving a firm, snappy snap animation similar to before.</p>

  <h3>2) Eliminate vertical nudge when toggling zoom</h3>
  <p><strong>Files:</strong> <span class="file">app/src/main/java/com/coroutines/swisstime/ui/screens/WelcomeScreen.kt</span></p>
  <ul>
    <li>Introduced a fixed-height bottom container (56dp) that always reserves space at the bottom of the screen.</li>
    <li>Switched between the informational <code>Text</code> and the CTA <code>Button</code> <em>inside</em> this container so the pager's vertical constraints remain stable.</li>
  </ul>
  <pre><code>// In WelcomeScreen.kt
val bottomHeight = 56.dp
Box(
    modifier = Modifier
        .constrainAs(button) {
            bottom.linkTo(parent.bottom, margin = 40.dp)
            start.linkTo(parent.start)
            end.linkTo(parent.end)
        }
        .padding(horizontal = 24.dp)
        .height(bottomHeight)
        .fillMaxWidth()
) {
    if (isZoomed) {
        Button(
            onClick = { /* save + navigate */ },
            modifier = Modifier.fillMaxSize()
        ) { Text("Select this watch") }
    } else {
        Text(
            text = "Tap to zoom",
            modifier = Modifier.fillMaxSize(),
            textAlign = TextAlign.Center
        )
    }
}
</code></pre>
  <p><strong>Why this works:</strong> Previously, swapping a short <code>Text</code> for a taller <code>Button</code> changed the bottom constraint height while the pager was constrained between top and bottom and also forced to be square (<code>aspectRatio(1f)</code>). The recomputation shifted the pager vertically. Keeping the bottom container height constant removes that trigger, so the pager stays put.</p>

  <h3>3) Remove the square artifact behind the watch during zoom</h3>
  <p><strong>Files:</strong> <span class="file">app/src/main/java/com/coroutines/swisstime/ui/components/SwissTimePager.kt</span></p>
  <ul>
    <li>Reordered the modifier chain so that any shared element transition (<code>sharedBounds</code>) is applied first, and the final outermost layer applies <code>graphicsLayer</code> with a circular shape and clipping.</li>
    <li>Disabled ripple/indication on the tap target to minimize extra press-time artifacts.</li>
  </ul>
  <pre><code>// In SwissTimePager.kt, inside the page content
var mod = Modifier
    .size(220.dp)
    .then(clickableModifier) // focused-only clickable with custom interactionSource

if (focused && sharedTransitionScope != null && animatedVisibilityScope != null) {
    with(sharedTransitionScope) {
        mod = mod.sharedBounds(
            sharedContentState = rememberSharedContentState(key = pageKey(page)),
            animatedVisibilityScope = animatedVisibilityScope,
            boundsTransform = { _, _ -&gt; spring(stiffness = 400f, dampingRatio = 0.85f) }
        )
    }
}

// Outermost compositing layer: circular clip + no elevation + animated scale/alpha
mod = mod.graphicsLayer {
    shape = CircleShape
    clip = true
    shadowElevation = 0f
    scaleX = finalScale
    scaleY = finalScale
    this.alpha = alpha
}
</code></pre>
  <p><strong>Why this works:</strong> The rectangular offscreen layer became visible during scaling and shared transitions because the clipped content was not the final composited layer. By making the outermost layer circular and clipped, the animated bitmap never draws beyond the circle, eliminating the square artifact.</p>

  <hr />
  <h2>Verification</h2>
  <ul>
    <li>Project builds successfully with the current BOM and dependencies.</li>
    <li>Tap-to-zoom on the focused watch:
      <ul>
        <li>No horizontal jitter while zoomed (<code>userScrollEnabled = !isZoomed</code>).</li>
        <li>No vertical nudge when switching between bottom <code>Text</code> and <code>Button</code>.</li>
        <li>No square artifact during zoom; the watch remains cleanly circular.</li>
      </ul>
    </li>
  </ul>

  <h2>Rationale Recap</h2>
  <ul>
    <li><strong>API alignment:</strong> Using only parameters supported by the resolved Foundation version removes build-time errors while keeping interaction feel predictable.</li>
    <li><strong>Stable constraints:</strong> Fixing the height of the bottom area prevents layout reflow that would otherwise move the pager.</li>
    <li><strong>Correct compositing order:</strong> Clipping at the outermost layer ensures the visible shape remains circular throughout animations, removing visual artifacts.</li>
  </ul>

  <h2>Optional Tweaks</h2>
  <ul>
    <li>Fine-tune <code>snapAnimationSpec</code> (duration/easing) to taste.</li>
    <li>Add <code>Modifier.animateContentSize()</code> to the bottom container if you want to animate height changes in other variants.</li>
    <li>Wrap inner watch content with an additional <code>clip(CircleShape)</code> if any custom drawing bypasses the outer clip (rare).</li>
  </ul>

  <hr />
  <p class="muted">Document location: <span class="file">zoom_and_pager_fix_report.html</span> (project root)</p>
</main>
</body>
</html>